<!-- filepath: templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drag and Drop Cards with D3.js</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        .canvas {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #f0f0f0;
        }
        .card {
            width: 100px;
            height: 100px;
            margin: 10px;
            padding: 10px;
            background-color: lightblue;
            border: 1px solid #ccc;
            position: absolute;
            cursor: move;
        }
    </style>
</head>
<body>
    <div class="canvas" id="canvas"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const canvas = d3.select("#canvas");

        const cardsData = {{ cards_data | tojson }};

        const cards = canvas.selectAll(".card")
            .data(cardsData)
            .enter()
            .append("div")
            .attr("class", "card")
            .attr("id", d => d.id)
            .style("left", d => `${d.x}px`)
            .style("top", d => `${d.y}px`)
            .text(d => d.text)
            .call(d3.drag()
                .on("start", dragStarted)
                .on("drag", dragged)
                .on("end", dragEnded)
            );

        function dragStarted(event, d) {
            d3.select(this).raise().classed("active", true);
        }

        function dragged(event, d) {
            d3.select(this)
                .style("left", `${d.x = event.x}px`)
                .style("top", `${d.y = event.y}px`);
        }

        function dragEnded(event, d) {
            d3.select(this).classed("active", false);

            // Send the card position update to the server
            fetch('/update_card_position', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    card_id: d.id,
                    new_position: { x: d.x, y: d.y }
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
            });
        }
    </script>
</body>
</html>